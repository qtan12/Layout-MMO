<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refresh User Data Demo</title>
    <script type="text/javascript">
    const API_URL = "https://panel.dongnai.net/api/v1/";
    </script>
    <script src="js/notification.js"></script>
    <script src="js/header.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <!-- Header Component (hidden) -->
    <div x-data="headerComponent()" style="display: none;"></div>
    
    <h1>Refresh User Data - Gi·∫£i Th√≠ch & Demo</h1>
    
    <!-- Kh·ªüi t·∫°o FastNotice -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.fastNotice = new FastNotice({
                position: 'bottom-right',
                duration: 3000,
                maxNotifications: 3
            });
        });
    </script>
    
    <!-- Gi·∫£i th√≠ch refreshUserData -->
    <div class="section">
        <h2>ü§î T·∫°i sao c·∫ßn refreshUserData?</h2>
        <p><strong>V·∫•n ƒë·ªÅ:</strong> Khi user c·∫≠p nh·∫≠t th√¥ng tin (avatar, t√™n, email...) ·ªü trang kh√°c, trang hi·ªán t·∫°i v·∫´n hi·ªÉn th·ªã data c≈© t·ª´ cache.</p>
        
        <div class="code-block">
// V√≠ d·ª•: User c·∫≠p nh·∫≠t avatar t·ª´ trang Profile
// Trang Home v·∫´n hi·ªÉn th·ªã avatar c≈© v√¨ d√πng cache
// ‚Üí C·∫ßn refreshUserData() ƒë·ªÉ l·∫•y data m·ªõi nh·∫•t
        </div>
    </div>

    <!-- Khi n√†o d√πng refreshUserData -->
    <div class="section">
        <h2>üìã Khi n√†o d√πng refreshUserData?</h2>
        <ul>
            <li><strong>Sau khi user c·∫≠p nh·∫≠t profile</strong> (avatar, t√™n, email...)</li>
            <li><strong>Sau khi user thay ƒë·ªïi settings</strong> (theme, language...)</li>
            <li><strong>Sau khi admin c·∫≠p nh·∫≠t th√¥ng tin user</strong></li>
            <li><strong>Khi c·∫ßn data m·ªõi nh·∫•t ngay l·∫≠p t·ª©c</strong> (b·ªè qua cache)</li>
        </ul>
    </div>

    <!-- C√°ch ho·∫°t ƒë·ªông -->
    <div class="section">
        <h2>‚öôÔ∏è C√°ch ho·∫°t ƒë·ªông c·ªßa refreshUserData</h2>
        <div class="code-block">
1. refreshUserData() ƒë∆∞·ª£c g·ªçi
2. X√≥a cache c≈© (clearUserCache)
3. G·ªçi API users/info/ ƒë·ªÉ l·∫•y data m·ªõi nh·∫•t
4. Cache data m·ªõi
5. C·∫≠p nh·∫≠t UI (updateAuthUI)
6. G·ª≠i data m·ªõi ƒë·∫øn t·∫•t c·∫£ components (sendUserData)
        </div>
    </div>

    <!-- Demo -->
    <div class="section">
        <h2>üß™ Demo Functions</h2>
        <button class="btn btn-primary" onclick="testRefresh()">Test refreshUserData()</button>
        <button class="btn btn-success" onclick="testClearCache()">Test clearUserCache()</button>
        <button class="btn btn-warning" onclick="showCacheStatus()">Show Cache Status</button>
        <button class="btn btn-danger" onclick="simulateUserUpdate()">Simulate User Update</button>
        <button class="btn btn-info" onclick="testFunctions()">Test Functions Availability</button>
        <button class="btn btn-primary" onclick="testAPICall()">Test Direct API Call</button>
    </div>

    <!-- V√≠ d·ª• s·ª≠ d·ª•ng -->
    <div class="section">
        <h2>üí° V√≠ d·ª• s·ª≠ d·ª•ng trong code</h2>
        <div class="code-block">
// Trong trang Profile sau khi user c·∫≠p nh·∫≠t avatar:
function updateAvatar() {
    // ... code c·∫≠p nh·∫≠t avatar ...
    
    // Sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng, refresh user data
    refreshUserData();
    sendNotice('Avatar ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
}

// Trong trang Settings sau khi user thay ƒë·ªïi theme:
function changeTheme() {
    // ... code thay ƒë·ªïi theme ...
    
    // Refresh ƒë·ªÉ l·∫•y settings m·ªõi nh·∫•t
    refreshUserData();
}
        </div>
    </div>

    <!-- So s√°nh -->
    <div class="section">
        <h2>üîÑ So s√°nh c√°c h√†m</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: #f8f9fa;">
                <th style="padding: 10px; border: 1px solid #ddd;">H√†m</th>
                <th style="padding: 10px; border: 1px solid #ddd;">M·ª•c ƒë√≠ch</th>
                <th style="padding: 10px; border: 1px solid #ddd;">G·ªçi API</th>
                <th style="padding: 10px; border: 1px solid #ddd;">C·∫≠p nh·∫≠t UI</th>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><code>checkAccessToken()</code></td>
                <td style="padding: 10px; border: 1px solid #ddd;">Kh·ªüi t·∫°o, ki·ªÉm tra cache tr∆∞·ªõc</td>
                <td style="padding: 10px; border: 1px solid #ddd;">Ch·ªâ khi kh√¥ng c√≥ cache</td>
                <td style="padding: 10px; border: 1px solid #ddd;">‚úÖ</td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><code>refreshUserData()</code></td>
                <td style="padding: 10px; border: 1px solid #ddd;">L·∫•y data m·ªõi nh·∫•t, b·ªè qua cache</td>
                <td style="padding: 10px; border: 1px solid #ddd;">Lu√¥n g·ªçi</td>
                <td style="padding: 10px; border: 1px solid #ddd;">‚úÖ</td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;"><code>clearUserCache()</code></td>
                <td style="padding: 10px; border: 1px solid #ddd;">X√≥a cache, kh√¥ng g·ªçi API</td>
                <td style="padding: 10px; border: 1px solid #ddd;">‚ùå</td>
                <td style="padding: 10px; border: 1px solid #ddd;">‚ùå</td>
            </tr>
        </table>
    </div>

    <script>
        // ƒê·ª£i Alpine.js load xong
        document.addEventListener('alpine:init', () => {
            console.log('Alpine.js initialized');
        });

        function testRefresh() {
            console.log('Testing refreshUserData()...');
            sendNotice('G·ªçi refreshUserData()...', 'info');
            
            // Ki·ªÉm tra xem header component c√≥ s·∫µn s√†ng kh√¥ng
            if (typeof refreshUserData === 'function') {
                refreshUserData();
                sendNotice('refreshUserData() called successfully!', 'success');
            } else {
                sendNotice('refreshUserData() function not found!', 'error');
            }
        }

        function testClearCache() {
            console.log('Testing clearUserCache()...');
            sendNotice('G·ªçi clearUserCache()...', 'info');
            
            if (typeof clearUserCache === 'function') {
                clearUserCache();
                sendNotice('clearUserCache() called successfully!', 'success');
            } else {
                sendNotice('clearUserCache() function not found!', 'error');
            }
        }

        function showCacheStatus() {
            const cacheData = localStorage.getItem('user_cache');
            const timestamp = localStorage.getItem('user_cache_at');
            
            let status = 'Cache Status:\n';
            status += `- Data: ${cacheData ? 'Present' : 'Empty'}\n`;
            status += `- Timestamp: ${timestamp || 'None'}\n`;
            
            if (timestamp) {
                const age = Math.floor((Date.now() - parseInt(timestamp)) / 1000);
                status += `- Age: ${age} seconds\n`;
            }
            
            console.log(status);
            alert(status);
        }

        function simulateUserUpdate() {
            console.log('Simulating user profile update...');
            sendNotice('Simulating user profile update...', 'info');
            
            // Clear cache to simulate fresh data needed
            if (typeof clearUserCache === 'function') {
                clearUserCache();
                
                // Then refresh to get new data
                setTimeout(() => {
                    if (typeof refreshUserData === 'function') {
                        refreshUserData();
                        sendNotice('User data refreshed after profile update!', 'success');
                    } else {
                        sendNotice('refreshUserData() function not found!', 'error');
                    }
                }, 1000);
            } else {
                sendNotice('clearUserCache() function not found!', 'error');
            }
        }

        // Test functions availability
        function testFunctions() {
            console.log('Testing function availability...');
            console.log('refreshUserData:', typeof refreshUserData);
            console.log('clearUserCache:', typeof clearUserCache);
            console.log('sendNotice:', typeof sendNotice);
            
            if (typeof refreshUserData === 'function' && typeof clearUserCache === 'function') {
                sendNotice('All functions are available!', 'success');
            } else {
                sendNotice('Some functions are missing!', 'error');
            }
        }

        // Test direct API call
        function testAPICall() {
            console.log('Testing direct API call...');
            sendNotice('Testing direct API call...', 'info');
            
            // Test if xhr function is available
            if (typeof window.xhr === 'function') {
                sendNotice('xhr function is available!', 'success');
                
                // Try to call API (this will fail without token, but we can see the attempt)
                window.xhr({
                    method: 'GET',
                    url: 'https://panel.dongnai.net/api/v1/users/info/',
                    headers: {
                        'Authorization': 'Bearer test-token'
                    },
                    withCredentials: false,
                    timeout: 5000
                }).then(response => {
                    console.log('API Response:', response);
                    sendNotice('API call successful!', 'success');
                }).catch(error => {
                    console.log('API Error:', error);
                    sendNotice('API call failed (expected without valid token)', 'warning');
                });
            } else {
                sendNotice('xhr function not found!', 'error');
            }
        }

        // Auto test on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testFunctions();
            }, 2000);
        });
    </script>
</body>
</html>
